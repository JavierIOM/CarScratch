---
import Layout from '../../layouts/Layout.astro';
import SearchForm from '../../components/SearchForm.astro';
import VehicleCard from '../../components/VehicleCard.astro';
import ExtrasCard from '../../components/ExtrasCard.astro';
import MOTHistory from '../../components/MOTHistory.astro';
import MileageChart from '../../components/MileageChart.astro';
import { getVehicleInfo } from '../../lib/aggregator';
import { isManxPlate, formatManxPlateForDisplay } from '../../lib/iom-detector';

const { reg } = Astro.params;

if (!reg) {
  return Astro.redirect('/');
}

const vehicleInfo = await getVehicleInfo(reg);

// Format registration for display
const formatReg = (r: string) => {
  // Use proper Manx formatting for IoM plates
  if (isManxPlate(r)) {
    return formatManxPlateForDisplay(r);
  }
  // Standard UK format: split after 4 characters
  const clean = r.replace(/\s/g, '').toUpperCase();
  if (clean.length > 4) {
    return clean.slice(0, 4) + ' ' + clean.slice(4);
  }
  return clean;
};

const formattedReg = formatReg(reg);

// Generate SEO metadata
const vehicle = vehicleInfo.vehicle;
const pageTitle = vehicle
  ? `${formattedReg} - ${vehicle.make} ${vehicle.model || ''} | CarScratch`
  : `${formattedReg} - Vehicle Lookup | CarScratch`;

const pageDescription = vehicle
  ? `View details for ${formattedReg}: ${vehicle.make} ${vehicle.model || ''}, ${vehicle.colour}, ${vehicle.fuelType}, ${vehicle.yearOfManufacture}. Check MOT history, tax status, and more.`
  : `Look up vehicle information for registration ${formattedReg}. Check MOT history, tax status, mileage, and specifications.`;

// Vehicle structured data for SEO
const vehicleSchema = vehicle ? {
  '@context': 'https://schema.org',
  '@type': 'Car',
  name: `${vehicle.make} ${vehicle.model || ''}`,
  manufacturer: vehicle.make,
  model: vehicle.model || undefined,
  vehicleIdentificationNumber: formattedReg,
  color: vehicle.colour,
  fuelType: vehicle.fuelType,
  vehicleEngine: vehicle.engineCapacity ? {
    '@type': 'EngineSpecification',
    engineDisplacement: {
      '@type': 'QuantitativeValue',
      value: vehicle.engineCapacity,
      unitCode: 'CMQ'
    }
  } : undefined,
  dateVehicleFirstRegistered: vehicle.monthOfFirstRegistration || undefined,
  modelDate: vehicle.yearOfManufacture?.toString()
} : null;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalPath={`/lookup/${reg.toUpperCase()}`}
  noIndex={!!vehicleInfo.error}
>
  {vehicleSchema && (
    <script is:inline type="application/ld+json" set:html={JSON.stringify(vehicleSchema)} />
  )}
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Search form at top -->
    <div class="mb-8">
      <SearchForm initialValue={formatReg(reg)} />
    </div>

    {vehicleInfo.error ? (
      <!-- Error state -->
      <div class="bg-slate-800/50 border border-slate-700 p-8 text-center">
        <div class="w-16 h-16 mx-auto mb-4 bg-red-500/10 text-red-400 flex items-center justify-center">
          <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 9v4" />
            <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.875h16.214a1.914 1.914 0 0 0 1.636 -2.875l-8.106 -13.534a1.914 1.914 0 0 0 -3.274 0z" />
            <path d="M12 16h.01" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold mb-2">Vehicle Not Found</h2>
        <p class="text-slate-400 mb-6">{vehicleInfo.error}</p>
        <a
          href="/"
          class="inline-block px-6 py-2 bg-amber-600 hover:bg-amber-500 text-slate-900 font-medium transition-colors"
        >
          Try Another Search
        </a>
      </div>
    ) : (
      <!-- Results -->
      <div class="space-y-6">
        {vehicleInfo.isManx && (
          <div class="flex items-center gap-2 text-sm">
            <span class="px-2 py-1 bg-red-600 text-white font-medium">Isle of Man</span>
            <span class="text-slate-400">Vehicle registered on the Isle of Man</span>
          </div>
        )}

        {vehicleInfo.vehicle && (
          <VehicleCard vehicle={vehicleInfo.vehicle} isManx={vehicleInfo.isManx} />
        )}

        {vehicleInfo.extras && (
          <ExtrasCard extras={vehicleInfo.extras} />
        )}

        {/* Previous UK Registration data for Manx plates */}
        {vehicleInfo.isManx && vehicleInfo.extras?.previousUKRegistration && (
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-400">Previous UK Registration</span>
              <div class="h-px flex-1 bg-slate-700/50"></div>
            </div>
            {vehicleInfo.ukVehicle && (
              <VehicleCard vehicle={vehicleInfo.ukVehicle} />
            )}
            {!vehicleInfo.ukVehicle && (
              <div class="bg-slate-800/30 border border-slate-700/50 p-4 text-sm text-slate-500">
                No UK vehicle data available for registration {vehicleInfo.extras.previousUKRegistration}.
              </div>
            )}
            {vehicleInfo.motHistory && (
              <div class="bg-blue-500/10 border border-blue-500/30 p-3">
                <p class="text-sm text-slate-400">
                  MOT history and mileage data below is from the previous UK registration{' '}
                  <a
                    href={`/lookup/${vehicleInfo.extras.previousUKRegistration.replace(/\s/g, '')}`}
                    class="text-amber-400 hover:text-amber-300 font-mono font-medium"
                  >
                    {vehicleInfo.extras.previousUKRegistration}
                  </a>.
                </p>
              </div>
            )}
          </div>
        )}

        {vehicleInfo.motHistory && vehicleInfo.motHistory.motTests.length > 1 && (
          <MileageChart tests={vehicleInfo.motHistory.motTests} />
        )}

        {vehicleInfo.motHistory && vehicleInfo.motHistory.motTests.length > 0 && (
          <MOTHistory history={vehicleInfo.motHistory} />
        )}

        {!vehicleInfo.vehicle && vehicleInfo.motHistory && (
          <!-- Only MOT data available -->
          <div class="bg-slate-800/50 border border-slate-700 p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 bg-amber-500/10 text-amber-400 flex items-center justify-center">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 9v4" />
                  <circle cx="12" cy="12" r="9" />
                  <path d="M12 16h.01" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold">Limited Data Available</h3>
                <p class="text-sm text-slate-400">Only MOT history is available for this vehicle.</p>
              </div>
            </div>
            <p class="text-sm text-slate-500">
              DVLA vehicle details are not available. This may be because the registration is very
              new, or there's an issue with the data source.
            </p>
          </div>
        )}

        {/* Insurance check link - UK vehicles only */}
        {!vehicleInfo.isManx && vehicleInfo.vehicle && (
          <div class="bg-slate-800/30 border border-slate-700/50 p-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-blue-500/10 text-blue-400 flex items-center justify-center flex-shrink-0">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-slate-300">Check if this vehicle is insured</p>
                <p class="text-xs text-slate-500">Via the Motor Insurance Database</p>
              </div>
            </div>
            <a
              href="https://ownvehicle.askmid.com/"
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 text-slate-200 transition-colors flex-shrink-0"
            >
              Check on askMID
            </a>
          </div>
        )}

        <!-- Data source notice -->
        <div class="text-center text-sm text-slate-600 py-4">
          {vehicleInfo.isManx ? (
            <p>Data sourced from Isle of Man Government Vehicle Search and UK MOT History Service.</p>
          ) : (
            <p>Data sourced from DVLA Vehicle Enquiry Service and MOT History Service.</p>
          )}
          <p class="mt-1">Last updated: {new Date().toLocaleDateString('en-GB')}</p>
        </div>
      </div>
    )}
  </div>
</Layout>

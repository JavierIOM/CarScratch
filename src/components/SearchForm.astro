---
interface Props {
  initialValue?: string;
}

const { initialValue = '' } = Astro.props;
---

<form id="search-form" class="w-full max-w-md mx-auto">
  <div class="relative">
    <div class="flex items-stretch">
      <!-- UK/IoM plate badge -->
      <div id="plate-badge" class="flex items-center justify-center w-10 bg-blue-700 rounded-l border-2 border-r-0 border-slate-600 text-white text-xs font-bold">
        GB
      </div>

      <!-- Input field styled like UK plate -->
      <input
        type="text"
        id="registration"
        name="registration"
        value={initialValue}
        placeholder="AB12 CDE"
        autocomplete="off"
        spellcheck="false"
        maxlength="12"
        class="flex-1 px-4 py-3 bg-amber-400 text-slate-900 text-xl font-bold tracking-wider uppercase placeholder:text-slate-600/50 placeholder:font-normal border-2 border-l-0 border-slate-600 focus:outline-none focus:border-amber-500"
        style="font-family: 'JetBrains Mono', monospace;"
      />

      <button
        type="submit"
        class="px-6 py-3 bg-amber-600 hover:bg-amber-500 text-slate-900 font-semibold rounded-r border-2 border-l-0 border-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-slate-900"
      >
        Search
      </button>
    </div>
  </div>

  <!-- Progress bar (hidden by default) -->
  <div id="progress-container" class="mt-2 h-1 bg-slate-700 rounded-full overflow-hidden hidden">
    <div id="progress-bar" class="h-full bg-amber-500 rounded-full animate-progress"></div>
  </div>

  <p id="search-hint" class="mt-3 text-sm text-slate-500 text-center">
    Enter a UK or Isle of Man registration number
  </p>
</form>

<style>
  @keyframes progress {
    0% {
      width: 0%;
      margin-left: 0%;
    }
    50% {
      width: 30%;
      margin-left: 35%;
    }
    100% {
      width: 0%;
      margin-left: 100%;
    }
  }
  .animate-progress {
    animation: progress 1.2s ease-in-out infinite;
  }
</style>

<script>
  const form = document.getElementById('search-form') as HTMLFormElement;
  const input = document.getElementById('registration') as HTMLInputElement;
  const badge = document.getElementById('plate-badge') as HTMLElement;

  // Check if a registration is a Manx plate
  function isManxPlate(reg: string): boolean {
    const clean = reg.toUpperCase().replace(/[\s-]+/g, '');
    const patterns = [
      /^[A-Z]MN\d+[A-Z]?$/i,      // PMN147E, AMN123
      /^MAN\d+[A-Z]?$/i,           // MAN6F, MAN123
      /^MANX\d+[A-Z]?$/i,          // MANX2, MANX100
      /^\d+MN\d+$/i,               // 1MN00
      /^[A-Z]{1,2}MN\d+[A-Z]?$/i,  // AMN, BMN, PMN etc
    ];
    return patterns.some(p => p.test(clean));
  }

  // Format Manx plate for display
  function formatManxPlate(reg: string): string {
    const clean = reg.toUpperCase().replace(/[\s-]+/g, '');
    const match = clean.match(/^([A-Z]+)(\d+)([A-Z]?)$/);
    if (match) {
      const [, letters, numbers, suffix] = match;
      return suffix ? `${letters} ${numbers} ${suffix}` : `${letters} ${numbers}`;
    }
    return clean;
  }

  // Format UK plate for display
  function formatUKPlate(reg: string): string {
    const clean = reg.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (clean.length > 4) {
      return clean.slice(0, 4) + ' ' + clean.slice(4);
    }
    return clean;
  }

  // Update the badge based on plate type
  function updateBadge(isManx: boolean) {
    if (isManx) {
      badge.classList.remove('bg-blue-700');
      badge.classList.add('bg-red-600');
      badge.textContent = 'M';
    } else {
      badge.classList.remove('bg-red-600');
      badge.classList.add('bg-blue-700');
      badge.textContent = 'GB';
    }
  }

  // Format input as user types
  input.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const clean = target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    const isManx = isManxPlate(clean);

    updateBadge(isManx);

    if (isManx) {
      target.value = formatManxPlate(clean);
    } else {
      target.value = formatUKPlate(clean);
    }
  });

  // Handle form submission
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const reg = input.value.replace(/\s/g, '').toUpperCase();

    if (reg.length < 2) return;

    // Show progress bar
    const progressContainer = document.getElementById('progress-container');
    const searchHint = document.getElementById('search-hint');
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

    if (progressContainer) progressContainer.classList.remove('hidden');
    if (searchHint) searchHint.textContent = 'Searching...';
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // Navigate to results page
    window.location.href = `/lookup/${encodeURIComponent(reg)}`;
  });

  // Initialize badge on page load if there's a value
  if (input.value) {
    const clean = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    updateBadge(isManxPlate(clean));
  }
</script>
